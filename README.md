# Codes for analysing whitecap coverage from moving platforms
The scripts and functions in this repository can be used to estimate the fractional whitecap coverage from sequential images acquired from moving platforms such as ships. The motion correction is performed with the horizon-detection algorithm published by [Schwendeman and Thomson (2015)](https://doi.org/10.1175/JTECH-D-14-00047.1), and the whitecap thresholding is performed following [Kleiss and Melville (2011)](https://doi.org/10.1175/2010JTECHO744.1).

## Overview
The `wc_fraction.py` script takes as input a directory of sequential images of the sea surface, performs horizon detection and stabilization, and finally determines a brightness threshold which is used to extract total whitecap coverage W from each image.

The following files are imported by the main `wc_fraction.py` script:
 - `gridding.py` Convert stabilized and geo-rectified images to regular 2D grids
 - `image_processing.py` Includes the main image processing functions 
 - `motion_correction.py` Horizon-based motion correction functions
 - `plotting.py` Function to generate example plots of output

## wc_fraction.py pipeline
The main script of wc_fraction.py performs the following operations in sequence. For the slow-running operations, the script saves output in .txt, .json and .nc formats, so that these functions only need to be run once.

1. The input images are undistorted based on the required calibration files, and the horizon line is estimated from the undistorted images. The horizon detection algorithm is based on Schwendeman and Thomson (2015), and uses a Hough transform on edge features returned by the Canny edge detection algorithm. We found that large, bright foam patches and whitecaps may at times cause the original horizon detection method to fail; this was to a large extent fixed by an additional thresholding of the undistorted images by Otsu's threshold prior to the edge detection step. Otsu's threshold robustly differentiates between sky and ocean, even in the presence of large foam features, and therefore gives a much higher success rate for recognizing the true horizon compared to only using Canny edge detection and the Hough transform. The horizon line parameters (radii and angles (theta) for the parametric horizon line formulation) are saved to .txt files. The incidence and roll angles of the ship are calculated from the radii and theta angles, and are also saved to .txt files for later use. For quality control purposes, timeseries plots are made and saved of the theta, roll and incidence angles. 

2. The detected horizon lines are used to "stabilize" (i.e. project to a stable reference frame) the undistorted images. This image stabilization rotates and warps the undistorted images, and introduces black borders of pixel intensity value 0 which should not be included in the whitecap analysis. The self.find_common_rect() function therefore finds in each stabilized image the region of interest (ROI) rectangle that maximizes the area it inscribes while excluding all border pixels. The upper edge of the ROI rectangle is set to 125 pixels below the horizon line, which translates to approximately 100 m away from the ship in the geo-rectified images. Once the maximum-area ROI has been found for each stabilized image, the "innermost" corners that fit inside all rectangles are extracted, giving one ROI rectangle that is henceforth used on each stabilized image. The corners of this ROI are saved in the file opt_corners.txt.

3. When the common ROI is found, each image is cropped to the ROI and geo-rectified using the incidence and roll angles determined from the horizon line. The geo-rectified images are gridded to a regular x,y grid of user-specified resolution, and timestamps are inferred from the embedded PointGrey image timestamps. All geo-rectified image grids, timestamps, x and y grids and grid border mask are saved in one big netcdf file.

4. The whitecap thresholding is performed on the geo-rectified image grids following the histogram method of Kleiss and Melville (2011; KM11). 50 different thresholds (based on varying percentages in the KM11 method) are saved in dictionary format in a .json file. The 20% threshold used by KM11 is adopted by default in this script. 

5. The total whitecap coverage is computed as the number of grid cells whose pixel intensity exceeds the 20% (default) threshold divided by the total number of non-masked grid cells in the geo-rectified image grids. The whitecap coverage of each image grid is saved in a separate netcdf file with the same timestamps as the image grids.

## Figures generated by default by wc_fraction.py

<img src="https://github.com/mikapm/ship-whitecaps/blob/main/example_figures/horizon_angles.png" width="500">
Time series of horizon angles ($\theta$, roll and incidence angles) produced by horizon detection method.

<img src="https://github.com/mikapm/stereo-wave/blob/master/sw_pyfuns/whitecaps/example_figures/min_area_bbox.png" width="500">
Largest common ROI box overlaid on image with smallest area visible.

<img src="https://github.com/mikapm/stereo-wave/blob/master/sw_pyfuns/whitecaps/example_figures/rectified_box_resolution.png" width="500">
Pixel x and y resolutions of geo-rectified projection. Used to define smallest acceptable grid resolution.

<img src="https://github.com/mikapm/stereo-wave/blob/master/sw_pyfuns/whitecaps/example_figures/reprojected_images_001.png" width="500">
Original, horizon-stabilized and geo-rectified & gridded input images.


<img src="https://github.com/mikapm/stereo-wave/blob/master/sw_pyfuns/whitecaps/example_figures/thresh_example_80cm_042.png" width="500">
Average pixel intensity histogram (normalized), second derivative of log of histogram L_pp (see Kleiss and Melville 2011, JTECH) and 3 different percentage-thresholds (percentages below last L_pp peak); original geo-rectified grid and three thresholded grids using the thresholds displayed in the top two plots.

<img src="https://github.com/mikapm/stereo-wave/blob/master/sw_pyfuns/whitecaps/example_figures/w_tot.png" width="500">
Time series of total whitecap coverage W_tot from using the specified precentage-threshold.

